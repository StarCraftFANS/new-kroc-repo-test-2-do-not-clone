#!/bin/bash 
BYTECODE_ADDR=0x5000
F_CPU=16000000
MCU="atmega328p"
UPLOAD_RATE=57600
BASE=`basename $2 .occ`
UPLOAD_PORT=$1

AVRDUDE_FLAGS="-V -F -p $MCU -P $UPLOAD_PORT -b $UPLOAD_RATE -c stk500v1"
AVRDUDE_WRITE_OCCAM="-D -U flash:w:$BASE.hex"

if [ -f $BASE.tbc ]; then
  echo "Removing old TBC file..."
  rm $BASE.tbc
fi

if [ -f $BASE.occ ]; then  
  echo "Compiling..."
  avr-occbuild -DF.CPU=16000000 --program $BASE.occ
else 
  echo
  echo "No upload port or file. Usage:"
  echo
  echo "  arduinocc <port> <file.occ>"
  echo
  exit
fi

if [ $? -eq 0 ]; then

  if [ -f $BASE.hex ]; then
    echo "Removing old HEX file..."
    rm $BASE.hex
  fi

  if [ $? -eq 0 ]; then
    echo "Converting to .hex..."
    binary-to-ihex $BYTECODE_ADDR $BASE.tbc $BASE.hex
  fi


  if [ $? -eq 0 ]; then
    echo "Uploading..."
    reset-arduino $UPLOAD_PORT
    avrdude -C /opt/occam/arduino/avrdude.conf $AVRDUDE_FLAGS $AVRDUDE_WRITE_OCCAM
  fi

  if [ $? -eq 0 ]; then
    echo "Reading..."
    read-arduino $UPLOAD_PORT
  fi
fi
